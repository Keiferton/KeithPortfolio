---
import Base from "@/layouts/Base.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const entries = await getCollection("products");
  return entries.map((entry) => ({ params: { slug: entry.slug }, props: { entry } }));
}

const { entry } = Astro.props;
const d = entry.data;
const { Content } = await entry.render();
const prettyDate = (iso?: string) => iso ? new Date(iso).toLocaleDateString(undefined,{year:"numeric",month:"short"}) : "";
---
<Base title={`${d.title} — Product`} description={d.summary}>
  <article class="prose prose-zinc dark:prose-invert max-w-none">
    <a href="/products" class="text-sm underline">← Back to Products</a>
    <header class="mt-2">
      <h1 class="mb-2">{d.title}</h1>
      <div class="text-sm text-zinc-600 dark:text-zinc-400 flex gap-3 flex-wrap">
        {d.date && <span>When: <span class="font-medium text-zinc-800 dark:text-zinc-100">{prettyDate(d.date)}</span></span>}
        {Array.isArray(d.tags) && d.tags.length > 0 && (
          <span>Tags: <span class="font-medium text-zinc-800 dark:text-zinc-100">{d.tags.join(", ")}</span></span>
        )}
      </div>
    </header>

    {d.glb && d.glbPath ? (
      <div class="my-6">
        <model-viewer
          src={d.glbPath}
          camera-controls
          interaction-prompt="none"
          style="width:100%;height:420px;background:#f7f7f7;border-radius:1rem;"
          exposure=".8"
          shadow-intensity=".8"
        ></model-viewer>
        <div class="text-xs text-zinc-500 dark:text-zinc-400 mt-2">Drag to rotate • Scroll to zoom</div>
      </div>
    ) : (
      d.cover && <img src={d.cover} alt={d.title} class="rounded-xl my-4 w-full max-w-xl mx-auto h-auto" />
    )}

    {Array.isArray(d.thumbs) && d.thumbs.length > 0 && (
      <div class="my-6 grid gap-4 sm:grid-cols-2">
        {d.thumbs.map((src: string, i: number) => (
          <figure
            class="overflow-hidden rounded-xl border border-zinc-200 dark:border-zinc-700 bg-white dark:bg-zinc-900 shadow-sm aspect-square flex items-center justify-center"
            key={i}
          >
            <img
              src={src}
              alt={`${d.title} image ${i + 1}`}
              class="w-full h-full object-cover"
              loading="lazy"
              decoding="async"
            />
          </figure>
        ))}
      </div>
    )}

    {d.glb && d.glbPath && (
      <div class="my-6">
        <model-viewer
          src={d.glbPath}
          camera-controls
          interaction-prompt="none"
          style="width:100%;height:420px;background:#f7f7f7;border-radius:1rem;"
          exposure=".8"
          shadow-intensity=".8"
        ></model-viewer>
        <div class="text-xs text-zinc-500 dark:text-zinc-400 mt-2">Drag to rotate • Scroll to zoom</div>
      </div>
    )}

    {d.links && (d.links.github || d.links.demo || d.links.site) && (
      <div class="my-4 p-4 bg-gray-50 dark:bg-zinc-800 rounded-lg border border-zinc-200 dark:border-zinc-600">
        <h2 class="text-lg font-semibold mb-2">Links</h2>
        <ul class="space-y-1">
          {d.links.github && <li><a class="underline text-zinc-800 dark:text-zinc-100" href={d.links.github} target="_blank" rel="noopener">GitHub</a></li>}
          {d.links.demo && <li><a class="underline text-zinc-800 dark:text-zinc-100" href={d.links.demo} target="_blank" rel="noopener">Demo</a></li>}
          {d.links.site && <li><a class="underline text-zinc-800 dark:text-zinc-100" href={d.links.site} target="_blank" rel="noopener">Site</a></li>}
        </ul>
      </div>
    )}

    <Content />
  </article>
</Base>
